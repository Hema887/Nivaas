pipeline {
    agent any
    tools {
        maven 'myMaven' // Ensure 'myMaven' is configured in Jenkins
    }

    stages {
        stage('Build') {
            when {
                changeRequest()  // This ensures the build runs only for pull requests
            }
            steps {
                dir('juvarya') { 
                    sh 'mvn clean install'  // Build the application
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main'  // This ensures deployment happens only after merging to the 'main' branch
            }
            steps {
                // Ensure you specify the SSH credentials here
                sshagent(['6141d2f1-dd35-46de-8af1-e298f328a4b4']) {
                    sh '''
                        ssh jenkins@20.2.249.184 '
                        git config --global --add safe.directory /opt/Sample/juvarya &&
                        cd /opt/Sample/juvarya &&
                        git stash &&  # Stash any local changes
                        git pull --allow-unrelated-histories &&  # Pull the latest code
                        git stash pop &&  # Reapply stashed changes
                        mvn clean install  # Build the application on the VM
                        '
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment was successful!'
        }
        failure {
            echo 'Deployment failed. Please check the logs.'
        }
    }
}
